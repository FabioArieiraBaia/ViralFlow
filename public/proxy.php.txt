<?php
// ATENCAO: Renomeie este arquivo para 'proxy.php' no seu servidor Apache/XAMPP

// Permite acesso de qualquer origem (CORS)
header("Access-Control-Allow-Origin: *");
header("Access-Control-Allow-Methods: GET, OPTIONS");
header("Access-Control-Allow-Headers: Content-Type");

// Se for apenas uma verificacao de pre-voo (OPTIONS), encerra aqui
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    exit(0);
}

// Parametros da requisicao
$prompt = $_GET['prompt'] ?? '';
$width = $_GET['width'] ?? 1024;
$height = $_GET['height'] ?? 1024;
$seed = $_GET['seed'] ?? 42;
$model = $_GET['model'] ?? 'turbo';

if (empty($prompt)) {
    http_response_code(400);
    echo "Prompt is required";
    exit;
}

// Monta a URL da Pollinations AI
$encodedPrompt = urlencode($prompt);
$targetUrl = "https://image.pollinations.ai/prompt/{$encodedPrompt}?width={$width}&height={$height}&seed={$seed}&nologo=true&model={$model}";

// Inicializa o cURL para buscar a imagem remotamente
$ch = curl_init();
curl_setopt($ch, CURLOPT_URL, $targetUrl);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);

// Define headers para simular um navegador real e evitar bloqueios
curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/125.0.0.0 Safari/537.36');
curl_setopt($ch, CURLOPT_REFERER, 'https://pollinations.ai/');

// Ignora verificacao SSL (opcional, util para XAMPP local as vezes)
curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$contentType = curl_getinfo($ch, CURLINFO_CONTENT_TYPE);

if (curl_errno($ch)) {
    http_response_code(500);
    echo 'Proxy Error: ' . curl_error($ch);
} else {
    // Repassa o status code e o tipo de conteudo (imagem)
    http_response_code($httpCode);
    header("Content-Type: " . $contentType);
    echo $response;
}

curl_close($ch);
?>